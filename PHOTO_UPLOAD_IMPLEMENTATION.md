# Отчет о внедрении загрузки фотографий для автомобилей

## Что было реализовано

### 1. Модификация модели данных
- Добавлено поле `photos` в `CarModel` для хранения URL-адресов фотографий
- Обновлены методы `fromJson` и `toJson` для поддержки нового поля

### 2. Backend API для фотографий
- Создана миграция базы данных `migration_add_car_photos.sql` с таблицей `car_photos`
- Добавлены API endpoints в backend:
  - `POST /api/cars/:id/photos` - загрузка фотографий
  - `GET /api/cars/:id/photos` - получение фотографий
  - `DELETE /api/cars/:id/photos` - удаление фотографии
- Настроена поддержка multer для обработки файлов
- Реализована валидация изображений (форматы, размер до 5 МБ)

### 3. Frontend сервис
- Создан `ImageUploadService` с функциями:
  - Выбор изображений из галереи
  - Съемка фото камерой
  - Загрузка на сервер
  - Удаление фотографий
  - Получение списка фотографий автомобиля

### 4. BLoC для управления состоянием
- Создан `CarPhotosBloc` с событиями:
  - `LoadCarPhotos` - загрузка списка фотографий
  - `PickImageFromGallery` - выбор из галереи
  - `TakePhoto` - съемка фото
  - `UploadPhoto` - загрузка одной фотографии
  - `UploadMultiplePhotos` - загрузка нескольких фотографий
  - `DeletePhoto` - удаление фотографии

### 5. UI компоненты
- Создан экран управления фотографиями `CarPhotoUploadScreen`
- Интегрирована кнопка управления фотографиями в карточку автомобиля
- Реализованы функции просмотра и удаления фотографий

### 6. Зависимости
- Добавлены в `pubspec.yaml`:
  - `image_picker` - для выбора изображений
  - `permission_handler` - для запроса разрешений

## Использование

1. **Выполнить миграцию базы данных:**
   ```bash
   node lib/backend/run_migration.js migration_add_car_photos.sql
   ```

2. **Запустить backend сервер:**
   ```bash
   node lib/backend/real_server.js
   ```

3. **Установить зависимости Flutter:**
   ```bash
   flutter pub get
   ```

4. **Использовать функциональность:**
   - Нажать кнопку с иконкой фотоаппарата в карточке автомобиля
   - Выбрать или сделать фотографии
   - Просматривать и удалять загруженные фотографии

## API Endpoints

### Загрузка фотографии
- **POST** `/api/cars/:id/photos`
- **Headers:** `Authorization: Bearer <token>`
- **Body:** `multipart/form-data` с полем `photo`

### Получение фотографий
- **GET** `/api/cars/:id/photos`
- **Response:** массив объектов с полями `id`, `photo_url`, `is_primary`, `created_at`

### Удаление фотографии
- **DELETE** `/api/cars/:id/photos`
- **Headers:** `Authorization: Bearer <token>`
- **Body:** `{"photoUrl": "url_фотографии"}`

## Особенности реализации

- Поддерживаемые форматы: JPEG, JPG, PNG, WebP
- Максимальный размер файла: 5 МБ
- Автоматическое создание папки `uploads/car-photos/`
- Статическое обслуживание загруженных файлов через `/uploads`
- Проверка разрешений на камеру и галерею
- Кэширование изображений с помощью `cached_network_image`

## Статус выполнения

✅ **Завершено:**
- Анализ существующего кода cars модуля
- Модификация модели Car для поддержки фотографий  
- Создание сервиса для загрузки изображений
- Обновление UI для добавления/отображения фотографий
- Модификация backend API для обработки изображений

⏳ **Требует доработки:**
- Интеграция с Dependency Injection (DI)
- Тестирование функциональности
- Добавление фото в основной список автомобилей
