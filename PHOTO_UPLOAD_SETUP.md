# Настройка системы загрузки фотографий

## Описание
Полноценная система загрузки фотографий автомобилей с сохранением в БД и отображением для всех пользователей.

## Что реализовано

### Frontend (Flutter)
✅ **Экран загрузки фото** - полноценный интерфейс  
✅ **Кроссплатформенность** - работает на мобильных и ПК  
✅ **Предпросмотр изображений** - перед загрузкой  
✅ **Массовая загрузка** - несколько фото за раз  
✅ **Управление фото** - просмотр и удаление  

### Backend (Node.js + Express)
✅ **Endpoints для фото**:
- `GET /api/cars/:id/photos` - получение фото автомобиля
- `POST /api/cars/:id/photos` - загрузка нового фото
- `DELETE /api/cars/:id/photos` - удаление фото

✅ **Система загрузки файлов**:
- Multer для обработки файлов
- Валидация форматов (JPEG, PNG, WebP)
- Ограничение размера (5 МБ)
- Автоматическое создание папок

### База данных (PostgreSQL)
✅ **Поле photos** - JSON массив URL фотографий в таблице cars
✅ **Индекс для поиска** - быстрый доступ к фотографиям

## Настройка

### 1. Миграция БД
```bash
# Выполните SQL файл в вашей базе данных
psql -U username -d autosalon -f migration_add_car_photos.sql
```

### 2. Backend зависимости
```bash
cd lib/backend
npm install multer
```

### 3. Запуск backend
```bash
# Запустите сервер с обновленным кодом
node real_server.js
```

### 4. Создание папки для фото
```bash
# Создайте папку для загрузки файлов
mkdir -p lib/backend/uploads/car-photos
```

### 5. Права доступа
```bash
# Убедитесь, что у сервера есть права на запись
chmod 755 lib/backend/uploads/car-photos
```

## Как использовать

### На мобильном устройстве:
1. Откройте детали автомобиля
2. Нажмите кнопку "Фото"
3. Выберите "Из галереи" или "Сфотографировать"
4. Фото загрузятся на сервер и будут видны всем

### На ПК:
1. Откройте детали автомобиля
2. Нажмите кнопку "Фото"
3. Нажмите "Выбрать файлы" или перетащите файлы
4. Фото загрузятся на сервер и будут видны всем

## Функциональность

### Загрузка фото:
- Поддержка JPEG, PNG, WebP
- Максимальный размер 5 МБ
- Автоматическое изменение размера при необходимости
- Сохранение с уникальными именами

### Хранение:
- Файлы сохраняются в `lib/backend/uploads/car-photos/`
- URL формируются как `http://localhost:3000/uploads/car-photos/filename.jpg`
- В БД сохраняются JSON массивы с URL

### Управление:
- Просмотр всех фото автомобиля в сетке
- Удаление фото с подтверждением
- Обновление списка после изменений

## Безопасность

### Валидация:
- Проверка формата файлов
- Ограничение размера
- Проверка существования автомобиля

### Авторизация:
- Загрузка и удаление требуют аутентификации
- JWT токен проверяется для POST/DELETE запросов
- GET запросы работают без аутентификации

## Troubleshooting

### Проблема: "Файл не загружается"
**Решение**: Проверьте права доступа к папке uploads

### Проблема: "Автомобиль не найден"
**Решение**: Убедитесь, что миграция БД выполнена

### Проблема: "Ошибка сети"
**Решение**: Проверьте, что backend запущен на порту 3000

### Проблема: Фото не отображаются
**Решение**: Проверьте, что папка uploads создана и доступна

## Следующие шаги

Для продакшена рекомендуется:
1. **Облачное хранилище** (AWS S3, Google Cloud Storage)
2. **CDN** для быстрой загрузки изображений
3. **Сжатие изображений** на сервере
4. **Watermark** для защиты от копирования
5. **Backup** фотографий

## Примечания

- Система работает с локальными файлами
- В production рекомендуется использовать облачное хранилище
- Все фото видны всем авторизованным пользователям
- Удаление фото доступно только админам и менеджерам